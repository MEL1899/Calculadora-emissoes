<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Carbono - Carbon Log</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --cor-primaria: #0d5c4a;
            --cor-primaria-hover: #0a4a3b;
            --cor-secundaria: #1a7a63;
            --cor-fundo: #f0f7f5;
            --cor-fundo-card: #ffffff;
            --cor-texto: #1a2e28;
            --cor-texto-suave: #5a6d67;
            --cor-borda: #d4e5e1;
            --sombra: 0 4px 20px rgba(13, 92, 74, 0.08);
            --sombra-foco: 0 0 0 3px rgba(13, 92, 74, 0.2);
            --raio: 12px;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 24px 60px;
            line-height: 1.6;
            background: var(--cor-fundo);
            color: var(--cor-texto);
        }
        .header {
            text-align: center;
            margin-bottom: 36px;
        }
        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--cor-texto);
            margin: 0 0 6px 0;
            letter-spacing: -0.02em;
        }
        .header .marca {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--cor-primaria);
            letter-spacing: 0.04em;
        }
        .formulario {
            background: var(--cor-fundo-card);
            padding: 32px;
            border-radius: var(--raio);
            box-shadow: var(--sombra);
            border: 1px solid var(--cor-borda);
        }
        .form-section {
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--cor-borda);
        }
        .form-section:last-of-type { border-bottom: none; }
        .form-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--cor-primaria);
            margin-bottom: 14px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group:last-child { margin-bottom: 0; }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--cor-texto);
        }
        input[type="email"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--cor-primaria);
            box-shadow: var(--sombra-foco);
        }
        input::placeholder { color: #9ab5ae; }
        .info-text {
            font-size: 0.8rem;
            color: var(--cor-texto-suave);
            margin-top: 6px;
        }
        .radio-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border: 1px solid var(--cor-borda);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
        }
        .radio-option:hover { background: var(--cor-fundo); }
        .radio-option input[type="radio"] { width: auto; cursor: pointer; accent-color: var(--cor-primaria); }
        .radio-option label { margin-bottom: 0; font-weight: 500; cursor: pointer; }
        .radio-option input:checked + label { color: var(--cor-primaria); }
        .radio-option:has(input:checked) {
            border-color: var(--cor-primaria);
            background: rgba(13, 92, 74, 0.06);
        }
        .hidden { display: none !important; }
        .address-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 12px;
        }
        @media (max-width: 600px) { .address-group { grid-template-columns: 1fr; } }
        .address-group label { font-size: 0.85rem; }
        .map-container { margin: 24px 0; }
        #map {
            height: 360px;
            width: 100%;
            border-radius: var(--raio);
            border: 1px solid var(--cor-borda);
            overflow: hidden;
        }
        .btn-calculate-distance {
            background: var(--cor-secundaria);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .btn-calculate-distance:hover { background: var(--cor-primaria); }
        .distance-result {
            margin-top: 10px;
            padding: 12px 14px;
            background: rgba(13, 92, 74, 0.08);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--cor-texto);
        }
        .btn-submit {
            width: 100%;
            padding: 16px;
            cursor: pointer;
            background: var(--cor-primaria);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            margin-top: 8px;
            transition: background 0.2s, transform 0.1s;
        }
        .btn-submit:hover { background: var(--cor-primaria-hover); }
        .btn-submit:active { transform: scale(0.99); }
    </style>
    <!-- Google Maps API - Carregamento Direto -->
    {% if google_maps_api_key and google_maps_api_key != 'YOUR_API_KEY' %}
    <script>
        // Vari√°vel global para controle
        window.GOOGLE_MAPS_LOADED = false;
        window.GOOGLE_MAPS_API_KEY = '{{ google_maps_api_key }}';
        
        // Carrega o Google Maps com tratamento de erros
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            
            script.onerror = function() {
                showMapError('Erro ao carregar o script do Google Maps. Verifique se bloqueadores de anuncios estao desativados.');
            };
            
            script.onload = function() {
                console.log('Script do Google Maps carregado com sucesso');
            };
            
            document.head.appendChild(script);
        }
        
        // Timeout para detectar se n√£o carregou
        setTimeout(function() {
            if (!window.GOOGLE_MAPS_LOADED && typeof google === 'undefined') {
                showMapError('Google Maps nao carregou. Verifique bloqueadores de anuncios ou restricoes de referenciador.');
            }
        }, 10000);
        
        // Fun√ß√£o para mostrar erro
        function showMapError(message) {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #e74c3c; background: #ffe6e6; border-radius: 8px;"><h3>Erro: Google Maps nao carregou</h3><p><strong>' + message + '</strong></p><p style="margin-top: 15px; font-size: 14px;"><strong>SOLUCOES:</strong></p><ol style="text-align: left; display: inline-block; max-width: 650px; font-size: 13px; line-height: 1.8;"><li><strong>Desative bloqueadores de anuncios</strong> (AdBlock, uBlock, etc.)</li><li>Acesse: <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #3498db;">Google Cloud Console</a></li><li>Em "Restricoes de aplicativo", escolha "Nenhuma"</li><li>Salve e aguarde 30 segundos</li><li>Recarregue: <strong>Ctrl+F5</strong></li></ol><p style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">Subir o site para a internet (com dominio proprio) pode resolver problemas de restricoes.</p></div>';
            }
        }
        
        // Carrega o script quando a p√°gina estiver pronta
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMapsScript);
        } else {
            loadGoogleMapsScript();
        }
    </script>
    {% else %}
    <script>
        // API key n√£o configurada
        function initMap() {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #e74c3c; background: #ffe6e6; border-radius: 8px;"><h3>‚ö†Ô∏è API Key n√£o configurada</h3><p>Configure sua API key no arquivo <code>config.py</code></p><p style="font-size: 12px; margin-top: 10px;">Veja as instru√ß√µes em <code>COMO_OBTER_API_KEY_GOOGLE_MAPS.md</code></p></div>';
            }
        }
    </script>
    {% endif %}
</head>
<body>
    <header class="header">
        <h1>üå± C√°lculo de Emiss√µes GEE</h1>
        <p class="marca">Carbon Log</p>
    </header>

    <div class="formulario">
        <form action="/calcular" method="post" id="formCalculo">
            <div class="form-section">
                <div class="form-section-title">Ve√≠culo e contato</div>
            <div class="form-group">
                <label>Tipo de ve√≠culo</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="tipo_carro" name="tipo_veiculo" value="carro" required checked>
                        <label for="tipo_carro">üöó Carro</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="tipo_caminhao" name="tipo_veiculo" value="caminhao" required>
                        <label for="tipo_caminhao">üöõ Caminh√£o</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>E-mail</label>
                <input type="email" name="email" required placeholder="seu@email.com">
            </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">Combust√≠vel e consumo</div>
            <div class="form-group">
                <label>Tipo de combust√≠vel</label>
                <select name="tipo_combustivel" required>
                    <option value="Diesel S10">Diesel S10</option>
                    <option value="Gasolina">Gasolina</option>
                    <option value="Etanol">Etanol</option>
                </select>
            </div>
            <div class="form-group">
                <label>Modo de c√°lculo</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="modo_preciso" name="modo_calculo" value="preciso" checked>
                        <label for="modo_preciso">Preciso (litros reais)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="modo_estimado" name="modo_calculo" value="estimado">
                        <label for="modo_estimado">Estimado (com base em km)</label>
                    </div>
                </div>
                <span class="info-text">Informe os litros consumidos ou deixe o sistema estimar a partir dos quil√¥metros rodados.</span>
            </div>
            <div class="form-group">
                <label data-label-litros>Litros de combust√≠vel</label>
                <input type="number" name="litros" step="0.01" min="0" required placeholder="Ex: 500,5">
            </div>
            <div class="form-group">
                <label>Ano de fabrica√ß√£o do ve√≠culo</label>
                <select name="ano_fabricacao" required>
                    {% for ano in range(ano_atual, 1989, -1) %}
                    <option value="{{ ano }}" {% if ano == ano_atual %}selected{% endif %}>{{ ano }}</option>
                    {% endfor %}
                </select>
                <span class="info-text">Usado no fator de ajuste por idade do ve√≠culo</span>
            </div>
            </div>

            <div class="form-section">
                <div class="form-section-title">üìç Rota (opcional)</div>
            <div class="form-group">
                <label>Origem e destino ‚Äî calcule a dist√¢ncia no mapa</label>
                <div class="address-group">
                    <div>
                        <label style="font-size: 13px; font-weight: 500;">Endere√ßo de Origem:</label>
                        <input type="text" id="endereco_origem" name="endereco_origem" placeholder="Digite endere√ßo, estabelecimento ou local">
                        <input type="hidden" id="lat_origem" name="lat_origem">
                        <input type="hidden" id="lng_origem" name="lng_origem">
                    </div>
                    <div>
                        <label style="font-size: 13px; font-weight: 500;">Endere√ßo de Destino:</label>
                        <input type="text" id="endereco_destino" name="endereco_destino" placeholder="Digite endere√ßo, estabelecimento ou local">
                        <input type="hidden" id="lat_destino" name="lat_destino">
                        <input type="hidden" id="lng_destino" name="lng_destino">
                    </div>
                </div>
                <button type="button" class="btn-calculate-distance" id="btn_calcular_distancia">üìè Calcular dist√¢ncia pela rota</button>
                <div id="distance_result" class="distance-result" style="display: none;"></div>
                <span class="info-text">Busque endere√ßos ou locais; a dist√¢ncia ser√° preenchida no campo "Quil√¥metros" abaixo.</span>
            </div>
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div class="form-group">
                <label>Quil√¥metros rodados</label>
                <input type="number" name="km_rodado" id="km_rodado" step="0.01" min="0" required placeholder="Ex: 2100">
                <span class="info-text">Pode ser preenchido automaticamente pelo mapa acima</span>
            </div>
            <div class="form-group" id="grupo_carga">
                <label>Carga transportada (toneladas)</label>
                <input type="number" name="carga_ton" id="carga_ton" step="0.01" min="0" placeholder="Ex: 25">
                <span class="info-text">Apenas para caminh√µes ‚Äî intensidade por tonelada</span>
            </div>
            </div>

            <button type="submit" class="btn-submit">Calcular e gerar relat√≥rio</button>
        </form>
    </div>

    <script>
        let map;
        let origemMarker = null;
        let destinoMarker = null;
        let origemAutocomplete;
        let destinoAutocomplete;
        let origemPlace;
        let destinoPlace;
        let isClickingOrigin = true; // Alterna entre origem e destino

        // Fun√ß√£o para mostrar/ocultar campo de carga baseado no tipo de ve√≠culo
        function toggleCampoCarga() {
            const tipoVeiculo = document.querySelector('input[name="tipo_veiculo"]:checked').value;
            const grupoCarga = document.getElementById('grupo_carga');
            const campoCarga = document.getElementById('carga_ton');
            
            if (tipoVeiculo === 'carro') {
                grupoCarga.classList.add('hidden');
                campoCarga.removeAttribute('required');
                campoCarga.value = '0'; // Define valor padr√£o para carro
            } else {
                grupoCarga.classList.remove('hidden');
                campoCarga.setAttribute('required', 'required');
                if (campoCarga.value === '0') {
                    campoCarga.value = ''; // Limpa o valor padr√£o quando mostrar
                }
            }
        }

        // Inicializa o mapa do Google
        function initMap() {
            // Marca que o mapa foi carregado
            window.GOOGLE_MAPS_LOADED = true;
            
            // Verifica se o Google Maps est√° carregado
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error('Google Maps n√£o foi carregado');
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #e74c3c; background: #ffe6e6; border-radius: 8px;"><h3>Google Maps nao carregado</h3><p>Verifique sua API key e as APIs habilitadas no Google Cloud Console.</p><p style="font-size: 12px;">Abra o console do navegador (F12) para ver erros detalhados.</p></div>';
                }
                return;
            }
            
            try {
                // Centro inicial (S√£o Carlos, SP - Brasil)
                const saoCarlos = { lat: -22.0084, lng: -47.8908 };
            
                map = new google.maps.Map(document.getElementById('map'), {
                    center: saoCarlos,
                    zoom: 13,
                    mapTypeControl: true,
                    streetViewControl: true
                });

                // Autocomplete para endere√ßo de origem (aceita endere√ßos, estabelecimentos e locais)
                if (typeof google.maps.places !== 'undefined') {
                    origemAutocomplete = new google.maps.places.Autocomplete(
                        document.getElementById('endereco_origem'),
                        { 
                            types: ['geocode', 'establishment']
                        }
                    );
                    origemAutocomplete.bindTo('bounds', map);
                    origemAutocomplete.addListener('place_changed', function() {
                        origemPlace = origemAutocomplete.getPlace();
                        if (!origemPlace.geometry) {
                            return;
                        }
                        if (origemPlace.geometry.viewport) {
                            map.fitBounds(origemPlace.geometry.viewport);
                        } else {
                            map.setCenter(origemPlace.geometry.location);
                            map.setZoom(17);
                        }
                        
                        // Remove marcador anterior e adiciona novo
                        if (origemMarker) {
                            origemMarker.setMap(null);
                        }
                        origemMarker = new google.maps.Marker({
                            map: map,
                            position: origemPlace.geometry.location,
                            title: 'Origem',
                            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                            draggable: true
                        });
                        
                        // Salva coordenadas
                        document.getElementById('lat_origem').value = origemPlace.geometry.location.lat();
                        document.getElementById('lng_origem').value = origemPlace.geometry.location.lng();
                        
                        origemMarker.addListener('dragend', function() {
                            const pos = origemMarker.getPosition();
                            document.getElementById('lat_origem').value = pos.lat();
                            document.getElementById('lng_origem').value = pos.lng();
                            if (window.directionsRenderer) {
                                window.directionsRenderer.setMap(null);
                            }
                            calcularDistancia();
                        });
                        
                        isClickingOrigin = false;
                        calcularDistancia();
                    });
                }

                // Autocomplete para endere√ßo de destino (aceita endere√ßos, estabelecimentos e locais)
                if (typeof google.maps.places !== 'undefined') {
                    destinoAutocomplete = new google.maps.places.Autocomplete(
                        document.getElementById('endereco_destino'),
                        { 
                            types: ['geocode', 'establishment']
                        }
                    );
                    destinoAutocomplete.bindTo('bounds', map);
                    destinoAutocomplete.addListener('place_changed', function() {
                        destinoPlace = destinoAutocomplete.getPlace();
                        if (!destinoPlace.geometry) {
                            return;
                        }
                        if (destinoPlace.geometry.viewport) {
                            map.fitBounds(destinoPlace.geometry.viewport);
                        } else {
                            map.setCenter(destinoPlace.geometry.location);
                            map.setZoom(17);
                        }
                        
                        // Remove marcador anterior e adiciona novo
                        if (destinoMarker) {
                            destinoMarker.setMap(null);
                        }
                        destinoMarker = new google.maps.Marker({
                            map: map,
                            position: destinoPlace.geometry.location,
                            title: 'Destino',
                            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                            draggable: true
                        });
                        
                        // Salva coordenadas
                        document.getElementById('lat_destino').value = destinoPlace.geometry.location.lat();
                        document.getElementById('lng_destino').value = destinoPlace.geometry.location.lng();
                        
                        destinoMarker.addListener('dragend', function() {
                            const pos = destinoMarker.getPosition();
                            document.getElementById('lat_destino').value = pos.lat();
                            document.getElementById('lng_destino').value = pos.lng();
                            if (window.directionsRenderer) {
                                window.directionsRenderer.setMap(null);
                            }
                            calcularDistancia();
                        });
                        
                        isClickingOrigin = true;
                        calcularDistancia();
                    });
                }

                // Permite clicar no mapa para definir origem/destino
                map.addListener('click', function(event) {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                
                if (isClickingOrigin) {
                    // Define origem
                    if (origemMarker) {
                        origemMarker.setMap(null);
                    }
                    origemMarker = new google.maps.Marker({
                        map: map,
                        position: event.latLng,
                        title: 'Origem',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                        draggable: true
                    });
                    document.getElementById('lat_origem').value = lat;
                    document.getElementById('lng_origem').value = lng;
                    
                    // Busca endere√ßo reverso
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: event.latLng }, function(results, status) {
                        if (status === 'OK' && results[0]) {
                            document.getElementById('endereco_origem').value = results[0].formatted_address;
                        }
                    });
                    
                    origemMarker.addListener('dragend', function() {
                        const pos = origemMarker.getPosition();
                        document.getElementById('lat_origem').value = pos.lat();
                        document.getElementById('lng_origem').value = pos.lng();
                        calcularDistancia();
                    });
                    
                    isClickingOrigin = false;
                } else {
                    // Define destino
                    if (destinoMarker) {
                        destinoMarker.setMap(null);
                    }
                    destinoMarker = new google.maps.Marker({
                        map: map,
                        position: event.latLng,
                        title: 'Destino',
                        icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        draggable: true
                    });
                    document.getElementById('lat_destino').value = lat;
                    document.getElementById('lng_destino').value = lng;
                    
                    // Busca endere√ßo reverso
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: event.latLng }, function(results, status) {
                        if (status === 'OK' && results[0]) {
                            document.getElementById('endereco_destino').value = results[0].formatted_address;
                        }
                    });
                    
                    destinoMarker.addListener('dragend', function() {
                        const pos = destinoMarker.getPosition();
                        document.getElementById('lat_destino').value = pos.lat();
                        document.getElementById('lng_destino').value = pos.lng();
                        calcularDistancia();
                    });
                    
                    isClickingOrigin = true;
                }
                
                calcularDistancia();
            });
                
            } catch (error) {
                console.error('Erro ao inicializar mapa:', error);
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #e74c3c;"><p>Erro ao inicializar o mapa: ' + error.message + '</p></div>';
                }
            }
        }

        // Fun√ß√£o para calcular dist√¢ncia de estrada entre origem e destino
        function calcularDistancia() {
            const latOrigem = parseFloat(document.getElementById('lat_origem').value);
            const lngOrigem = parseFloat(document.getElementById('lng_origem').value);
            const latDestino = parseFloat(document.getElementById('lat_destino').value);
            const lngDestino = parseFloat(document.getElementById('lng_destino').value);
            
            if (latOrigem && lngOrigem && latDestino && lngDestino) {
                const origem = new google.maps.LatLng(latOrigem, lngOrigem);
                const destino = new google.maps.LatLng(latDestino, lngDestino);
                
                // Remove rota anterior se existir
                if (window.directionsRenderer) {
                    window.directionsRenderer.setMap(null);
                }
                if (window.routeLine) {
                    window.routeLine.setMap(null);
                }
                
                // Usa Directions Service para calcular dist√¢ncia de estrada
                const directionsService = new google.maps.DirectionsService();
                const directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: true, // N√£o mostra marcadores padr√£o (j√° temos os nossos)
                    preserveViewport: false, // Permite ajustar zoom
                    polylineOptions: {
                        strokeColor: '#3498db',
                        strokeWeight: 4,
                        strokeOpacity: 0.7
                    }
                });
                
                directionsService.route({
                    origin: origem,
                    destination: destino,
                    travelMode: google.maps.TravelMode.DRIVING, // Modo de condu√ß√£o (estrada)
                    unitSystem: google.maps.UnitSystem.METRIC // Sistema m√©trico (km)
                }, function(response, status) {
                    if (status === 'OK') {
                        // Desenha a rota no mapa
                        directionsRenderer.setDirections(response);
                        
                        // Calcula a dist√¢ncia total da rota
                        let distanciaTotal = 0;
                        const route = response.routes[0];
                        route.legs.forEach(function(leg) {
                            distanciaTotal += leg.distance.value; // Dist√¢ncia em metros
                        });
                        
                        const distanciaKm = (distanciaTotal / 1000).toFixed(2);
                        
                        // Atualiza campo de quil√¥metros
                        document.getElementById('km_rodado').value = distanciaKm;
                        
                        // Mostra resultado
                        const resultDiv = document.getElementById('distance_result');
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = 'üìç Dist√¢ncia calculada e preenchida no campo "Quil√¥metros Rodados" abaixo.';
                        
                        // Ajusta zoom para mostrar toda a rota
                        const bounds = new google.maps.LatLngBounds();
                        route.legs.forEach(function(leg) {
                            bounds.extend(leg.start_location);
                            bounds.extend(leg.end_location);
                        });
                        map.fitBounds(bounds);
                        
                        // Salva o renderer para poder remov√™-lo depois
                        window.directionsRenderer = directionsRenderer;
                    } else {
                        // Se falhar, usa c√°lculo de linha reta como fallback
                        console.warn('Erro ao calcular rota:', status);
                        const distancia = google.maps.geometry.spherical.computeDistanceBetween(origem, destino);
                        const distanciaKm = (distancia / 1000).toFixed(2);
                        document.getElementById('km_rodado').value = distanciaKm;
                        
                        const resultDiv = document.getElementById('distance_result');
                        resultDiv.style.display = 'block';
                        resultDiv.innerHTML = '‚ö†Ô∏è Dist√¢ncia aproximada preenchida no campo "Quil√¥metros Rodados" (linha reta - rota n√£o calculada).';
                        
                        // Desenha linha reta como fallback
                        if (window.routeLine) {
                            window.routeLine.setMap(null);
                        }
                        window.routeLine = new google.maps.Polyline({
                            path: [origem, destino],
                            geodesic: true,
                            strokeColor: '#e74c3c',
                            strokeOpacity: 0.5,
                            strokeWeight: 2
                        });
                        window.routeLine.setMap(map);
                    }
                });
            }
        }

        // Adiciona event listeners aos radio buttons
        document.querySelectorAll('input[name="tipo_veiculo"]').forEach(radio => {
            radio.addEventListener('change', toggleCampoCarga);
        });

        // Alterna UI de acordo com o modo de c√°lculo (preciso x estimado)
        function toggleModoCalculo() {
            const modo = document.querySelector('input[name="modo_calculo"]:checked')?.value || 'preciso';
            const campoLitros = document.querySelector('input[name="litros"]');
            const labelLitros = document.querySelector('[data-label-litros]');
            
            if (!campoLitros || !labelLitros) return;

            if (modo === 'estimado') {
                campoLitros.disabled = true;
                campoLitros.required = false;
                campoLitros.value = '';
                campoLitros.placeholder = 'Ser√° estimado a partir dos km rodados';
                labelLitros.textContent = 'Litros de combust√≠vel (estimado)';
            } else {
                campoLitros.disabled = false;
                campoLitros.required = true;
                campoLitros.placeholder = 'Ex: 500,5';
                labelLitros.textContent = 'Litros de combust√≠vel';
            }
        }

        document.querySelectorAll('input[name="modo_calculo"]').forEach(radio => {
            radio.addEventListener('change', toggleModoCalculo);
        });

        // Bot√£o para calcular dist√¢ncia manualmente
        document.getElementById('btn_calcular_distancia').addEventListener('click', calcularDistancia);

        // Executa na carga da p√°gina para definir o estado inicial
        document.addEventListener('DOMContentLoaded', function() {
            toggleCampoCarga();
            toggleModoCalculo();
        });
        
        // Fun√ß√£o para lidar com erro de autentica√ß√£o do Google Maps
        window.gm_authFailure = function() {
            console.error('Google Maps Auth Failure - API key inv√°lida ou sem permiss√£o');
            window.GOOGLE_MAPS_LOADED = false;
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="padding: 50px; text-align: center; color: #e74c3c; background: #ffe6e6; border-radius: 8px;"><h3>Erro de Autenticacao do Google Maps</h3><p><strong>PROBLEMA: Restricoes de Referenciador (HTTP Referrer)</strong></p><p style="margin-top: 15px; font-size: 14px;"><strong>SOLUCAO IMEDIATA:</strong></p><ol style="text-align: left; display: inline-block; max-width: 650px; font-size: 13px; line-height: 1.8;"><li>Acesse: <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #3498db;">Google Cloud Console - Credenciais</a></li><li>Clique na sua API key (AIzaSyCaRYgdfZVFac-8...)</li><li>Em <strong>"Restricoes de aplicativo"</strong>:<ul style="margin-top: 5px;"><li>Escolha <strong>"Nenhuma"</strong> (temporariamente para testar)</li><li>OU escolha "Referenciadores de HTTP" e adicione:<ul><li><code>http://localhost:*</code></li><li><code>http://127.0.0.1:*</code></li></ul></li></ul></li><li>Clique em <strong>"SALVAR"</strong> e aguarde 30 segundos</li><li>Recarregue esta pagina: <strong>Ctrl+F5</strong></li></ol><p style="margin-top: 20px; font-size: 12px; color: #7f8c8d;">As APIs estao funcionando (teste confirmado). O problema e apenas as restricoes de acesso do navegador.</p></div>';
            }
        };
    </script>
</body>
</html>